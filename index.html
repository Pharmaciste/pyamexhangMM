<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MAMMON TIMER</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0a0d14;--panel:#0b0f1aee;--panel-border:rgba(255,255,255,.08);
    --text:#ffffff;--ok:#22c55e;--danger:#ef4444;--accent:#fbbf24;--accent-2:#fde047;--shadow:rgba(0,0,0,.45)
  }
  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{
    font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(80vw 60vh at 70% -20%, rgba(253,224,71,.06), transparent 60%),
      radial-gradient(70vw 50vh at -10% 0%, rgba(251,191,36,.06), transparent 60%),
      var(--bg) url('https://images.unsplash.com/photo-1517817748496-62bc3047b9ff?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat fixed;
    min-height:100vh;
  }
  .overlay{position:relative; z-index:1; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35)); min-height:100vh;}
  .wrap{max-width:980px; margin:0 auto; padding:18px 18px 60px;}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand-logo{width:28px; height:28px; background:url('/assets/mammon.png') center/contain no-repeat; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5)); cursor:pointer}
  .brand-title{font-weight:900; letter-spacing:.3px}
  .badge{font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111;}
  .header-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}

  .panel{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:18px; box-shadow:0 12px 30px var(--shadow); backdrop-filter: blur(6px)}
  h1{margin:6px 0 10px; font-size:30px; font-weight:900}
  .clock{font:42px/1.1 ui-monospace,Menlo,Consolas,monospace; margin:6px 0 10px}
  .status{margin:8px 0 2px; font-weight:900; letter-spacing:.3px}
  .status.open{color:var(--ok)} .status.closed{color:var(--danger)}
  .sub{opacity:.95}
  .row{display:flex; gap:10px; justify-content:center; margin:12px 0 4px}
  .led{width:22px; height:22px; border-radius:7px; border:1px solid rgba(0,0,0,.6); background:#0b1323; box-shadow: inset 0 0 12px rgba(0,0,0,.6), 0 0 12px rgba(0,0,0,.25)}
  .led.g{ background:var(--ok); box-shadow:0 0 10px rgba(34,197,94,.6) }
  .led.r{ background:var(--danger); box-shadow:0 0 10px rgba(239,68,68,.6) }
  .led-info{text-align:center; font-size:12px; opacity:.85; margin-bottom:8px;}
  .meta{margin-top:10px; font-size:12px; opacity:.9}
  .next{margin-top:12px; font-size:13px; opacity:.96}

  /* Privacy (toggle) */
  .pp-cta-wrap{margin:22px 0 8px; display:flex; justify-content:center}
  .pp-cta{padding:9px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f172a; color:#fff; text-decoration:none}
  .pp-cta:hover{border-color:#334155}
  .privacy{display:none; margin-top:16px}
  .privacy .box{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:16px; box-shadow:0 12px 30px var(--shadow)}
  .privacy h2{margin:0 0 10px; font-size:20px; font-weight:900}
  .privacy h3{margin:16px 0 6px; font-size:16px; font-weight:800}
  .privacy p, .privacy li{color:#dbeafe}

  /* Admin (protégé) */
  .btn{padding:9px 12px; border-radius:12px; border:1px solid var(--panel-border); background:#0f172a; color:#fff; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111; border-color:transparent; font-weight:900}
  .admin{display:none; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:16px}
  .admin input[type="time"]{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b0e1a; color:#fff; width:140px}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:10}
  .modal .box{background:#0f1220; border:1px solid var(--panel-border); border-radius:12px; padding:16px; width:100%; max-width:360px}
</style>
</head>
<body>
<div class="overlay">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="brand">
        <div class="brand-logo" id="secretLogo" aria-hidden="true" title="Double-clic pour Admin"></div>
        <div class="brand-title">MAMMON TIMER</div>
        <span class="badge">LIVE</span>
      </div>
      <div class="header-right">
        <span class="mini-badge" id="patchBadge">Updated for Star Citizen Patch 4.3.0-LIVE (Hotfix 10188864)</span>
      </div>
    </header>

    <!-- Timer -->
    <section class="panel">
      <h1>Executive Hangar Timer</h1>
      <div class="clock" id="clock">--:--:--</div>

      <div class="row" id="leds">
        <div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div>
      </div>
      <div class="led-info" id="ledInfo">Fermé : 1 LED ≈ 24 min • Ouvert : 1 LED = 12 min (+ 5 min “black”)</div>

      <div class="status closed" id="status">Hangar Closed</div>
      <div class="sub" id="subtitle">Prochaine transition dans --:--:--</div>

      <div class="next" id="nextTimes">Prochaine fermeture : — • Prochaine ouverture : —</div>
      <div class="meta" id="modeMeta">Ancre initiale : <b>prochaine ouverture à 16:28 (heure locale)</b>. Modifiable via Admin (mot de passe).</div>

      <!-- Admin (après login) -->
      <div class="admin" id="adminPanel">
        <label for="openTime"><strong>Dernière ouverture (HH:MM)</strong> :</label>
        <input type="time" id="openTime" step="60" />
        <button class="btn primary" id="applyLocal">Appliquer (local)</button>
        <button class="btn" id="togglePause">Pause/Reprendre</button>
        <button class="btn" id="reset1628">Réinitialiser → prochaine 16:28</button>
        <button class="btn" id="logout">Se déconnecter</button>
        <div style="flex-basis:100%; text-align:center; font-size:12px; opacity:.8">Astuce : mets l’heure de la <em>dernière</em> ouverture observée pour un calage précis.</div>
      </div>
    </section>

    <!-- Privacy -->
    <div class="pp-cta-wrap">
      <a href="#privacy" id="ppBtn" class="pp-cta" aria-expanded="false" aria-controls="privacy">Privacy Policy</a>
    </div>
    <section class="privacy" id="privacy" aria-hidden="true">
      <div class="box">
        <h2>Privacy Policy</h2>
        <p><em>Effective Date: September 8, 2025</em></p>

        <p>We do <strong>not</strong> collect, sell, or share personal data. Timer preferences (anchor time, pause) may be saved in your browser’s <strong>Local Storage</strong>. This data stays on your device.</p>

        <h3>Cookies &amp; Tracking</h3>
        <p>No cookies currently. If ads are enabled in the future, third parties may use cookies you can control in your browser.</p>

        <h3>Your Rights</h3>
        <p>Depending on your location (GDPR/CCPA), you may have rights like access, correction, deletion. Since we don’t collect personal data, these mainly relate to cookies if enabled later.</p>

        <h3>Data Retention</h3>
        <p>Local Storage data remains on your device until you clear it.</p>

        <h3>Changes</h3>
        <p>We may update this Policy from time to time. We will post changes here with a new Effective Date.</p>
      </div>
    </section>

  </div>
</div>

<!-- Modal Admin (login) -->
<div class="modal" id="modal" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 10px; font-size:18px">Connexion admin</h3>
    <div class="field" style="display:flex; gap:8px">
      <input type="password" id="pwd" placeholder="Mot de passe admin" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b0e1a;color:#fff" />
      <button class="btn" id="doLogin">OK</button>
    </div>
    <div class="actions" style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end">
      <button class="btn" id="closeModal">Fermer</button>
    </div>
  </div>
</div>

<script>
  /* ====== Réglages de cycle ====== */
  const OPEN_SEC   = 65 * 60;     // 65:00
  const CLOSED_SEC = 7201;        // ~120:01
  const CYCLE_SEC  = OPEN_SEC + CLOSED_SEC;
  const DOTS = 5;

  /* ====== Admin (mot de passe local) ====== */
  const ADMIN_PASSWORD = 'MAMMON'; // ⚠️ change-moi

  /* ====== DOM ====== */
  const elClock=document.getElementById('clock');
  const elStatus=document.getElementById('status');
  const elSub=document.getElementById('subtitle');
  const leds=document.getElementById('leds').children;
  const elNext=document.getElementById('nextTimes');
  const elMode=document.getElementById('modeMeta');
  const elLedInfo=document.getElementById('ledInfo');

  const adminPanel=document.getElementById('adminPanel');
  const inputTime=document.getElementById('openTime');
  const btnApply=document.getElementById('applyLocal');
  const btnPause=document.getElementById('togglePause');
  const btnReset1628=document.getElementById('reset1628');
  const btnLogout=document.getElementById('logout');

  const modal=document.getElementById('modal');
  const pwdInput=document.getElementById('pwd');
  const doLoginBtn=document.getElementById('doLogin');
  const closeModal=document.getElementById('closeModal');
  const secretLogo=document.getElementById('secretLogo');

  const ppBtn=document.getElementById('ppBtn');
  const ppSection=document.getElementById('privacy');

  /* ====== Etat (Local Storage) ====== */
  const LS_ANCHOR='mammon_anchor_iso';
  const LS_PAUSE='mammon_paused';
  let anchor_iso=null; // ISO d'une heure D'OUVERTURE
  let paused=false;
  let isAdmin=false;

  /* ====== Utils ====== */
  const pad=n=>String(n).padStart(2,'0');
  const fmt=s=>{s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`;};
  const pretty=ms=>new Date(ms).toLocaleString('fr-FR',{dateStyle:'short', timeStyle:'short'});
  const toISO=ms=>new Date(ms - new Date().getTimezoneOffset()*60000).toISOString().replace('.000Z','Z');

  function saveState(){
    try{ localStorage.setItem(LS_ANCHOR, anchor_iso||''); localStorage.setItem(LS_PAUSE, paused?'1':'0'); }catch{}
  }
  function loadState(){
    try{
      const a=localStorage.getItem(LS_ANCHOR); if(a) anchor_iso=a;
      const p=localStorage.getItem(LS_PAUSE);  paused=(p==='1');
    }catch{}
  }

  function anchorMs(){
    return anchor_iso ? Date.parse(anchor_iso) : Date.now();
  }

  function nextAfter(startMs, stepMs, nowMs){
    return (nowMs<startMs)?startMs:startMs+(Math.floor((nowMs-startMs)/stepMs)+1)*stepMs;
  }

  function computeISOFromHHMM(hhmm){
    const [hh,mm]=hhmm.split(':').map(Number);
    const now=new Date();
    const d=new Date(now); d.setHours(hh,mm,0,0);
    // “Dernière ouverture” => si l'heure est dans le futur, prendre hier
    if(d.getTime()>now.getTime()) d.setDate(d.getDate()-1);
    return toISO(d.getTime());
  }

  function setAnchorToNext1628(){
    const now=new Date();
    const next=new Date(now);
    next.setHours(16,28,0,0);
    if(next.getTime()<=now.getTime()) next.setDate(next.getDate()+1); // prochaine occurrence
    anchor_iso=toISO(next.getTime());
    elMode.textContent='Ancre initiale : prochaine ouverture à 16:28 ('+pretty(next.getTime())+')';
    saveState();
  }

  /* ====== LED logic ====== */
  // fermé : 0→5 vertes (≈24 min chacune). La 5e n’apparaît qu’au tout dernier instant.
  function greensClosed(remainSec){
    const seg=CLOSED_SEC/DOTS;
    return Math.max(0, Math.min(DOTS, DOTS - Math.ceil(remainSec/seg)));
  }
  // ouvert : 5→0 vertes (12 min chacune), puis 5 min “black” (0 LED mais ouvert)
  function greensOpen(elapsedOpenSec){
    if(elapsedOpenSec>=60*60 && elapsedOpenSec<65*60) return 0; // black final 5 min
    if(elapsedOpenSec>=65*60) return DOTS; // sécurité modulo
    const step=Math.floor(elapsedOpenSec/(12*60)); // 0..4
    return Math.max(0, Math.min(DOTS, DOTS - step));
  }

  function render(){
    if(!anchor_iso){
      elClock.textContent='--:--:--';
      elStatus.className='status closed';
      elStatus.textContent='Initialisation…';
      elSub.textContent='Aucune ancre définie';
      elNext.textContent='—';
      return;
    }

    const now=Date.now();
    const base=anchorMs();
    const elapsed=((now-base)/1000)%CYCLE_SEC; // secondes écoulées dans le cycle
    const inOpen = elapsed < OPEN_SEC;

    const phaseElapsed = inOpen ? elapsed : (elapsed-OPEN_SEC);
    const phaseSec     = inOpen ? OPEN_SEC : CLOSED_SEC;
    const remain       = phaseSec - phaseElapsed;

    // Clock + status
    elClock.textContent=fmt(remain);
    elStatus.className='status '+(inOpen?'open':'closed');
    elStatus.textContent='Hangar '+(inOpen?'Open':'Closed')+(paused?' (Paused)':'');
    elSub.textContent='Prochaine transition ('+(inOpen?'fermeture':'ouverture')+') dans '+fmt(remain);

    // LEDs
    const green = inOpen ? greensOpen(phaseElapsed) : greensClosed(remain);
    for(let i=0;i<DOTS;i++) leds[i].className='led '+(i<green?'g':'r');
    elLedInfo.textContent = inOpen ? 'Ouvert : 1 LED = 12 min • dernières 5 min sans LED'
                                   : 'Fermé : 1 LED ≈ 24 min';

    // Prochaines échéances
    const nClose=nextAfter(base+OPEN_SEC*1000, CYCLE_SEC*1000, now);
    const nOpen =nextAfter(base,                CYCLE_SEC*1000, now);
    elNext.textContent=`Prochaine fermeture : ${pretty(nClose)} • Prochaine ouverture : ${pretty(nOpen)}`;
  }

  /* ======*
