<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CZ Timers — Mammon</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0a0d14;
    --panel:#0b0f1aee;
    --panel-border:rgba(255,255,255,.08);
    --text:#ffffff;
    --muted:#cbd5e1;

    /* Accent JAUNE (couleur du logo) */
    --accent:#fbbf24;       /* amber-400 */
    --accent-2:#fde047;     /* amber-300 */
    --danger:#ef4444;
    --ok:#22c55e;
    --shadow:rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(80vw 60vh at 70% -20%, rgba(253, 224, 71, .06), transparent 60%),
      radial-gradient(70vw 50vh at -10% 0%, rgba(251, 191, 36, .06), transparent 60%),
      var(--bg) url('https://images.unsplash.com/photo-1517817748496-62bc3047b9ff?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat fixed;
    min-height:100vh;
  }
  /* Watermark logo en fond (grand, discret) */
  .wm{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      url('/assets/mammon.png') center 35% / min(80vmin,900px) no-repeat;
    opacity:.09; filter: drop-shadow(0 0 18px rgba(0,0,0,.6));
  }
  .overlay{position:relative; z-index:1; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35)); min-height:100vh;}
  .wrap{max-width:980px; margin:0 auto; padding:18px 18px 60px;}

  /* Bannière info */
  .announce{
    display:flex; align-items:center; justify-content:center; gap:10px;
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    color:#111; font-weight:800; letter-spacing:.2px;
    border-radius:12px; padding:10px 14px; box-shadow:0 10px 26px var(--shadow); margin-bottom:14px;
  }
  .announce small{opacity:.85; font-weight:700}
  .ann-close{margin-left:auto; border:none; background:#00000022; color:#111; font-weight:900; border-radius:8px; padding:4px 8px; cursor:pointer}

  /* Header */
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand-logo{width:28px; height:28px; background:url('/assets/mammon.png') center/contain no-repeat; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5))}
  .brand-title{font-weight:900; letter-spacing:.3px}
  .badge{
    font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px;
    background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111;
  }
  .chip{
    border:1px solid var(--panel-border); background:#0f172a; color:#fff;
    padding:6px 10px; border-radius:12px; cursor:pointer;
  }
  .chip:hover{border-color:#334155}

  /* Panel */
  .panel{
    background:var(--panel); border:1px solid var(--panel-border);
    border-radius:16px; padding:18px;
    box-shadow:0 12px 30px var(--shadow); backdrop-filter: blur(6px);
  }

  /* Timer */
  h1{margin:6px 0 10px; font-size:30px; font-weight:900; text-shadow:0 1px 2px rgba(0,0,0,.35)}
  .clock{font:42px/1.1 ui-monospace,Menlo,Consolas,monospace; margin:6px 0 10px}
  .status{margin:8px 0 2px; font-weight:900; letter-spacing:.3px}
  .status.open{color:var(--ok)}
  .status.closed{color:var(--danger)}
  .sub{opacity:.95}
  .row{display:flex; gap:10px; justify-content:center; margin:12px 0 8px}
  .led{
    width:22px; height:22px; border-radius:7px;
    border:1px solid rgba(0,0,0,.6);
    background:#0b1323;
    box-shadow: inset 0 0 12px rgba(0,0,0,.6), 0 0 12px rgba(0,0,0,.25);
  }
  .led.g{ background:var(--ok); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 16px rgba(34,197,94,.45) }
  .led.r{ background:var(--danger); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 14px rgba(239,68,68,.35) }

  .meta{margin-top:10px; font-size:12px; opacity:.9}
  .next{margin-top:12px; font-size:13px; opacity:.96}

  /* Admin */
  .admin{display:none; margin-top:16px; gap:10px; flex-direction:column}
  .admin-row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center}
  .btn{padding:9px 12px; border-radius:12px; border:1px solid var(--panel-border); background:#0f172a; color:#fff; cursor:pointer;}
  .btn.primary{ background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111; border-color:transparent; font-weight:900 }
  .btn:hover{ border-color:#334155 }
  .admin input[type="time"]{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b0e1a; color:#fff}

  /* Modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:20px; z-index:10}
  .modal .box{background:#0f1220; border:1px solid var(--panel-border); border-radius:12px; padding:16px; width:100%; max-width:360px}
  .modal h3{margin:0 0 10px; font-size:18px}
  .field{display:flex; gap:8px}
  .field input{flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b0e1a; color:#fff}
  .actions{display:flex; gap:8px; margin-top:10px; justify-content:flex-end}

  footer{margin-top:22px; padding-top:12px; font-size:12px; opacity:.7; text-align:center}
</style>
</head>
<body>
<div class="wm" aria-hidden="true"></div>
<div class="overlay">
  <div class="wrap">

    <!-- Bannière version SC -->
    <div class="announce" id="announce" style="display:none">
      <span id="annText">Mise à jour SC — Timer à jour. Go cook.</span>
      <small id="annMeta"></small>
      <button class="ann-close" id="annClose">×</button>
    </div>

    <!-- Header -->
    <header>
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-title">CZ Timers</div>
        <span class="badge">LIVE</span>
      </div>
      <button class="chip" id="loginBtn">Admin</button>
    </header>

    <!-- Panel Timer -->
    <section class="panel">
      <h1>Executive Hangar Timer</h1>
      <div class="clock" id="clock">--:--:--</div>

      <div class="row" id="leds">
        <div class="led g"></div><div class="led g"></div><div class="led g"></div><div class="led g"></div><div class="led g"></div>
      </div>

      <div class="status closed" id="status">Hangar Closed</div>
      <div class="sub" id="subtitle">Prochaine transition dans --:--:--</div>

      <div class="next" id="nextTimes">Prochaine fermeture : — • Prochaine ouverture : —</div>
      <div class="meta" id="modeMeta">Config globale chargée.</div>

      <!-- Admin -->
      <div class="admin" id="adminPanel">
        <div class="admin-row">
          <label for="openTime">Dernière ouverture (HH:MM) :</label>
          <input type="time" id="openTime" step="60" />
        </div>
        <div class="admin-row">
          <button class="btn primary" id="publishGlobal">Mettre à jour GLOBAL</button>
          <button class="btn" id="togglePauseGlobal">Pause/Reprendre GLOBAL</button>
          <button class="btn" id="reload">Recharger</button>
          <button class="btn" id="logout">Se déconnecter</button>
        </div>
        <div class="meta">Indique l’heure <b>locale</b> de la dernière ouverture observée. Le site recalcule pour tous.</div>
      </div>
    </section>

    <footer>© 2025 Mammon — Thème sombre & accent jaune.</footer>
  </div>
</div>

<!-- Modal Admin -->
<div class="modal" id="modal">
  <div class="box">
    <h3>Connexion admin</h3>
    <div class="field">
      <input type="password" id="pwd" placeholder="Mot de passe admin (Vercel → ADMIN_PASSWORD)" />
      <button class="btn" id="doLogin">OK</button>
    </div>
    <div class="actions"><button class="btn" id="closeModal">Fermer</button></div>
  </div>
</div>

<script>
  /* ===== Réglages ===== */
  const OPEN_MIN=60, CLOSED_MIN=120, DOTS=5;
  const OPEN_SEC=OPEN_MIN*60, CLOSED_SEC=CLOSED_MIN*60, CYCLE_SEC=OPEN_SEC+CLOSED_SEC;

  /* Texte bannière — modifie simplement SC_VERSION si tu veux */
  const SC_VERSION = "SC 4.x";
  const ANNOUNCE_TEXT = `Mise à jour ${SC_VERSION} — Timer à jour sur la dernière version. Go cook.`;

  /* ===== Éléments ===== */
  const elClock=document.getElementById('clock');
  const elStatus=document.getElementById('status');
  const elSub=document.getElementById('subtitle');
  const leds=document.getElementById('leds').children;
  const elNext=document.getElementById('nextTimes');
  const elMode=document.getElementById('modeMeta');

  const loginBtn=document.getElementById('loginBtn');
  const adminPanel=document.getElementById('adminPanel');
  const inputTime=document.getElementById('openTime');
  const btnPublish=document.getElementById('publishGlobal');
  const btnPause=document.getElementById('togglePauseGlobal');
  const btnReload=document.getElementById('reload');
  const btnLogout=document.getElementById('logout');

  const modal=document.getElementById('modal');
  const pwdInput=document.getElementById('pwd');
  const doLoginBtn=document.getElementById('doLogin');
  const closeModal=document.getElementById('closeModal');

  const ann=document.getElementById('announce');
  const annText=document.getElementById('annText');
  const annMeta=document.getElementById('annMeta');
  const annClose=document.getElementById('annClose');

  /* ===== State global (API) ===== */
  let cfg={anchor_iso:'2025-09-07T16:53:00Z', manual_offset_seconds:0, paused:false};

  /* ===== Utils ===== */
  const pad=n=>String(n).padStart(2,'0');
  const fmt=s=>{s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`;};
  const pretty=ms=>new Date(ms).toLocaleString('fr-FR',{dateStyle:'short', timeStyle:'short'});
  const anchorMs=()=>Date.parse(cfg.anchor_iso)+(cfg.manual_offset_seconds||0)*1000;
  const nextAfter=(startMs,stepMs,nowMs)=>(nowMs<startMs)?startMs:startMs+(Math.floor((nowMs-startMs)/stepMs)+1)*stepMs;

  /* ===== Timer render ===== */
  function render(){
    const now=Date.now();
    const elapsed=(((now-anchorMs())/1000)%CYCLE_SEC+CYCLE_SEC)%CYCLE_SEC;
    const isOpen=elapsed<OPEN_SEC;
    const remain=isOpen ? OPEN_SEC-elapsed : CYCLE_SEC-elapsed;

    elClock.textContent = fmt(remain);
    elStatus.className='status '+(isOpen?'open':'closed');
    elStatus.textContent = 'Hangar '+(isOpen?'Open':'Closed') + (cfg.paused?' (Paused)':'');
    elSub.textContent = 'Prochaine transition ('+(isOpen?'fermeture':'ouverture')+') dans '+fmt(remain);

    // LEDs progressives
    const phaseSec=isOpen?OPEN_SEC:CLOSED_SEC;
    const progress=remain/phaseSec; // 1 -> 0
    let greenCount = isOpen ? Math.ceil(progress*DOTS) : DOTS - Math.ceil(progress*DOTS);
    greenCount=Math.max(0,Math.min(DOTS,greenCount));
    for(let i=0;i<DOTS;i++) leds[i].className='led '+(i<greenCount?'g':'r');

    // Prochaines transitions
    const nClose=nextAfter(anchorMs()+OPEN_SEC*1000, CYCLE_SEC*1000, now);
    const nOpen =nextAfter(anchorMs(),                CYCLE_SEC*1000, now);
    elNext.textContent = `Prochaine fermeture : ${pretty(nClose)} • Prochaine ouverture : ${pretty(nOpen)}`;
  }

  async function loadCfg(){
    const r=await fetch('/api/anchor?ts='+Date.now(),{cache:'no-store'});
    if(!r.ok){ elMode.textContent='Erreur API: '+r.status; return; }
    cfg=await r.json();
    elMode.textContent='Config globale chargée. Dernière MAJ globale : '+pretty(Date.parse(cfg.anchor_iso));
    // Bannière
    annText.textContent = ANNOUNCE_TEXT;
    annMeta.textContent = 'MAJ globale : '+pretty(Date.parse(cfg.anchor_iso));
    if(localStorage.getItem('ann_dismiss_v1')!=='1'){ ann.style.display='flex'; }
    const d=new Date(); inputTime.value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
    render();
  }

  /* ===== Admin session ===== */
  let isAdmin=false, adminPwd=null;
  function setAdminUI(v){ isAdmin=v; adminPanel.style.display=v?'flex':'none'; loginBtn.textContent=v?'Admin ✓':'Admin'; if(!v) adminPwd=null; }

  loginBtn.onclick = ()=>{ if(isAdmin){ setAdminUI(false); } else { modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); } };
  doLoginBtn.onclick= ()=>{ adminPwd=pwdInput.value.trim(); if(!adminPwd){ alert('Entre le mot de passe'); return; } setAdminUI(true); modal.style.display='none'; };
  closeModal.onclick=()=>{ modal.style.display='none'; };
  btnLogout.onclick=()=> setAdminUI(false);

  /* ===== Admin actions ===== */
  document.getElementById('publishGlobal').onclick= async ()=>{
    if(!isAdmin || !adminPwd){ modal.style.display='flex'; return; }
    const val=inputTime.value.trim(); if(!val) return alert('Indique HH:MM');
    const [hh,mm]=val.split(':').map(Number); if(Number.isNaN(hh)||Number.isNaN(mm)) return alert('Heure invalide');

    // Dernière occurrence locale -> ISO UTC
    const now=new Date(); const d=new Date(now); d.setHours(hh,mm,0,0); if(d.getTime()>now.getTime()) d.setDate(d.getDate()-1);
    const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().replace('.000Z','Z');

    const r=await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:adminPwd,anchor_iso:iso,manual_offset_seconds:0,paused:false})});
    if(!r.ok){ if(r.status===401){ setAdminUI(false); alert('Mot de passe incorrect'); return; } const t=await r.text().catch(()=> ''); return alert('Échec: '+r.status+' '+t); }
    cfg=await r.json(); alert('✅ Mise à jour globale enregistrée'); loadCfg();
  };

  document.getElementById('togglePauseGlobal').onclick= async ()=>{
    if(!isAdmin || !adminPwd){ modal.style.display='flex'; return; }
    const r=await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:adminPwd,anchor_iso:cfg.anchor_iso,manual_offset_seconds:cfg.manual_offset_seconds||0,paused:!cfg.paused})});
    if(!r.ok){ if(r.status===401){ setAdminUI(false); alert('Mot de passe incorrect'); return; } const t=await r.text().catch(()=> ''); return alert('Échec: '+r.status+' '+t); }
    cfg=await r.json(); render();
  };

  document.getElementById('reload').onclick= loadCfg;

  /* Bannière dismiss */
  annClose.onclick = ()=>{ ann.style.display='none'; localStorage.setItem('ann_dismiss_v1','1'); };

  /* Go */
  setInterval(render,1000);
  loadCfg();
</script>
</body>
</html>
