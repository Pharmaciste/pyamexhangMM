<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mammon Timer â€” Executive Hangar</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0a0a0a; --panel:#111111ee; --panel-border:rgba(255,255,255,.08);
    --text:#fefce8; --ok:#22c55e; --danger:#ef4444;
    --accent:#facc15; --accent2:#fde047;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  /* Mammon watermark â€” lÃ©ger */
  .wm{position:fixed;inset:0;background:url('/assets/mammon.png') center 50%/min(86vmin,1100px) no-repeat;
      opacity:.10;pointer-events:none;filter:drop-shadow(0 0 20px rgba(0,0,0,.55))}
  .wrap{max-width:980px;margin:0 auto;padding:20px;position:relative;z-index:1}

  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand-logo{width:28px;height:28px;background:url('/assets/mammon.png') center/contain no-repeat;cursor:pointer}
  .brand h1{font-size:20px;font-weight:900;margin:0;color:var(--accent)}
  .badge{font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;
         background:#000;color:var(--accent);border:1px solid var(--accent)}
  .patch{font-size:13px;color:var(--ok)}
  .patch-date{font-size:12px;opacity:.85;margin-top:2px}

  .discord-bar{background:#1a1a1a;border:1px solid rgba(255,255,255,.1);border-radius:12px;
               padding:10px 14px;margin-bottom:16px;text-align:center}
  .discord-bar a{color:var(--accent2);font-weight:700;text-decoration:none}

  .panel{background:var(--panel);border:1px solid var(--panel-border);border-radius:14px;padding:16px}
  h2{font-size:22px;font-weight:900;margin:0 0 10px;color:var(--accent)}
  .big{font:64px/1.1 ui-monospace,monospace;margin:10px 0}
  .big.open{color:var(--ok)} .big.closed{color:var(--danger)}
  .until{font:14px ui-monospace,monospace;opacity:.95;margin:6px 0}
  .clock{font:56px/1 ui-monospace,monospace;margin:10px 0;color:var(--accent)}
  .status{font-weight:900}
  .status.open{color:var(--ok)} .status.closed{color:var(--danger)}

  .row{display:flex;gap:10px;justify-content:center;margin:12px 0}
  .led{width:22px;height:22px;border-radius:7px;background:#222;border:1px solid rgba(0,0,0,.6)}
  .led.g{background:var(--ok);box-shadow:0 0 14px rgba(34,197,94,.7)}
  .led.r{background:var(--danger);box-shadow:0 0 12px rgba(239,68,68,.6)}

  .sched{margin-top:24px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px 10px;border-top:1px solid rgba(255,255,255,.1);vertical-align:top}
  th{color:var(--accent);text-align:left}
  .cycle-cell{width:80px;font-weight:700;color:#e5e7eb}
  .status-cell{width:140px}
  .time-cell{white-space:nowrap}
  .tag{padding:2px 8px;border-radius:999px;font-size:12px}
  .tag.on{background:rgba(34,197,94,.12);color:var(--ok);border:1px solid rgba(34,197,94,.45)}
  .tag.off{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.45)}

  /* Admin dock (en bas de page, affichÃ© aprÃ¨s mot de passe OK) */
  .admin-dock{display:none;margin:20px 0 6px}
  .admin-panel{background:#0f0f0f;border:1px solid var(--panel-border);border-radius:12px;padding:14px}
  .admin-title{margin:0 0 8px;font-weight:800}
  .row-flex{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .admin-panel input[type="password"],
  .admin-panel input[type="time"]{padding:8px 10px;border-radius:8px;border:1px solid #333;background:#0a0a0a;color:#fff}
  .btn{padding:8px 12px;border-radius:8px;background:#000;color:var(--accent);
       border:1px solid var(--accent);cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.danger{color:#fff;border-color:#ef4444;background:#ef4444}
  .hint{font-size:12px;opacity:.75;margin-top:6px}
</style>
</head>
<body>
<div class="wm" aria-hidden="true"></div>

<div class="wrap">
  <!-- Header -->
  <header>
    <div class="brand">
      <div class="brand-logo" id="secretLogo" title="Click to open admin at bottom"></div>
      <h1>MAMMON TIMER</h1>
      <span class="badge">LIVE</span>
    </div>
    <div>
      <div class="patch">Updated for Star Citizen Patch 4.3.0-LIVE (Hotfix 10188864)</div>
      <div class="patch-date" id="patchDate"></div>
    </div>
  </header>

  <!-- Discord bar -->
  <div class="discord-bar">
    ðŸš€ Want to join <b>MAMMON</b>? <a href="https://discord.gg/aUBDScHG" target="_blank" rel="noopener">Join our Discord here!</a>
  </div>

  <!-- Timer -->
  <section class="panel">
    <h2>Executive Hangar Timer</h2>

    <div id="statusBig" class="big closed">OFFLINE</div>

    <div class="until">Time until next change: <span id="until">--:--:--</span></div>

    <div class="row" id="leds">
      <div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div>
    </div>

    <div class="clock" id="clock">--:--:--</div>
    <div class="status closed" id="status">Hangar Closed</div>
    <div class="until" id="subtitle">Next transition in --:--</div>
    <div class="until" id="nextTimes">Next Close: â€” â€¢ Next Open: â€”</div>

    <div class="sched">
      <h3>Schedule (24h)</h3>
      <div id="schedule"></div>
    </div>
  </section>

  <!-- Admin dock (bottom) -->
  <section class="admin-dock" id="adminDock">
    <div class="admin-panel">
      <h3 class="admin-title">Admin</h3>

      <!-- Bloc mot de passe -->
      <div class="row-flex" id="adminLock">
        <label for="adminPwd"><strong>Password</strong></label>
        <input type="password" id="adminPwd" placeholder="Enter admin password">
        <button class="btn" id="btnUnlock">Unlock</button>
      </div>

      <!-- Bloc commandes (visible uniquement aprÃ¨s dÃ©verrouillage) -->
      <div id="adminControls" style="display:none">
        <div class="row-flex" style="margin-top:10px">
          <label for="openTime"><strong>Set last open (HH:MM)</strong> (seconds forced to :06)</label>
          <input type="time" id="openTime" step="60">
          <button class="btn" id="btnApply">Apply</button>
          <button class="btn" id="btnPause">Pause/Resume Hangar</button>
        </div>
        <div class="hint">This will rebase the timer and rebuild the 24h schedule from the provided open time.</div>
      </div>

      <div class="hint">Shortcut: Ctrl+Shift+A â€¢ Click the Mammon icon to toggle this panel.</div>
      <div class="row-flex" style="margin-top:10px">
        <button class="btn danger" id="btnCloseDock">Close panel</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ====== Config & constants ====== */
const OPEN_SEC  = 65*60;              // 65:00
const CLOSED_SEC= 2*3600 + 1;         // 2:00:01
const CYCLE_SEC = OPEN_SEC + CLOSED_SEC;
const CYCLE_MS  = CYCLE_SEC*1000;
const DOTS = 5;
const ADMIN_PWD = 'jhhvuxju12';       // ðŸ” password fourni

/* ====== Anchor (today 20:14:06 local) ====== */
const ANCHOR = new Date();
ANCHOR.setHours(20,14,6,0);
let anchor_ms = ANCHOR.getTime();

/* ====== State ====== */
let paused = false;
let isAdmin = false;
let dockVisible = false;

/* ====== DOM ====== */
const elClock   = document.getElementById('clock');
const elUntil   = document.getElementById('until');
const elStatus  = document.getElementById('status');
const elStatusBig = document.getElementById('statusBig');
const elSub     = document.getElementById('subtitle');
const elNext    = document.getElementById('nextTimes');
const leds      = document.getElementById('leds').children;
const scheduleDiv = document.getElementById('schedule');
const patchDate = document.getElementById('patchDate');

const secretLogo = document.getElementById('secretLogo');
const adminDock  = document.getElementById('adminDock');
const adminLock  = document.getElementById('adminLock');
const adminControls = document.getElementById('adminControls');
const inputPwd   = document.getElementById('adminPwd');
const inputTime  = document.getElementById('openTime');
const btnUnlock  = document.getElementById('btnUnlock');
const btnApply   = document.getElementById('btnApply');
const btnPause   = document.getElementById('btnPause');
const btnCloseDock = document.getElementById('btnCloseDock');

/* ====== Utils ====== */
const pad=n=>String(n).padStart(2,'0');
const fmtHMS=s=>{ s=Math.floor(s); return `${pad((s/3600)|0)}:${pad(((s%3600)/60)|0)}:${pad(s%60)}`; };
const fmtMMSS=s=>{ s=Math.floor(s); return `${pad((s/60)|0)}:${pad(s%60)}`; };
const pretty=ms=>new Date(ms).toLocaleString('en-GB',{dateStyle:'short',timeStyle:'medium'});

/* LEDs: number of green bulbs left (others are red) */
function ledCount(remain,isOpen){
  if(isOpen){
    if(remain<=300) return 0;              // last 5 min -> all red
    const eff=Math.min(3600,remain-300);   // 60 min progress window
    return Math.min(DOTS, Math.ceil(eff/(60*12))); // ~12 min per LED
  }else{
    const seg=CLOSED_SEC/DOTS;             // ~24 min per LED
    return Math.max(0, DOTS - Math.ceil(remain/seg));
  }
}
function nextAfter(start,step,now){ return now<start ? start : start + (Math.floor((now-start)/step)+1)*step; }

/* ====== Rendering ====== */
let lastMinute=-1;
function render(force=false){
  if(paused) return;

  const now = Date.now();
  const elapsed = (((now - anchor_ms)/1000) % CYCLE_SEC + CYCLE_SEC) % CYCLE_SEC;
  const isOpen = elapsed < OPEN_SEC;

  const phaseSec = isOpen ? OPEN_SEC : CLOSED_SEC;
  const phaseElapsed = isOpen ? elapsed : (elapsed - OPEN_SEC);
  const remain = phaseSec - phaseElapsed;

  // Timers
  elUntil.textContent = fmtHMS(remain);       // HH:MM:SS
  elClock.textContent = fmtHMS(remain);       // HH:MM:SS
  elSub.textContent = 'Next transition ('+(isOpen?'close':'open')+') in ' + fmtMMSS(remain); // MM:SS

  // Status colors
  elStatus.textContent = 'Hangar ' + (isOpen ? 'Open' : 'Closed');
  elStatus.className = 'status ' + (isOpen ? 'open' : 'closed');
  elStatusBig.textContent = isOpen ? 'ONLINE' : 'OFFLINE';
  elStatusBig.className = 'big ' + (isOpen ? 'open' : 'closed');

  // LEDs (greens first; remaining turn red)
  const g=ledCount(remain,isOpen);
  for(let i=0;i<DOTS;i++) leds[i].className='led '+(i<g?'g':'r');

  // Next events
  const nextOpen = nextAfter(anchor_ms, CYCLE_MS, now);
  const nextClose= nextAfter(anchor_ms + OPEN_SEC*1000, CYCLE_MS, now);
  elNext.textContent = `Next Close: ${pretty(nextClose)} â€¢ Next Open: ${pretty(nextOpen)}`;

  // Schedule refresh once per minute
  const m = new Date(now).getMinutes();
  if(force || m!==lastMinute){ lastMinute=m; updateSchedule(now); }
}

/* ====== Schedule: two rows per cycle (Online / Offline) ====== */
function updateSchedule(nowMs){
  const rows=[];
  const horizon=nowMs+24*3600*1000;

  // last open <= now
  let n=Math.floor((nowMs - anchor_ms)/CYCLE_MS);
  let openStart=anchor_ms + n*CYCLE_MS;
  if(openStart>nowMs){ n--; openStart-=CYCLE_MS; }

  while(openStart < horizon){
    const cycleNum = 49 + Math.round((openStart - anchor_ms)/CYCLE_MS);
    const closeTime = openStart + OPEN_SEC*1000;

    if(closeTime>=nowMs || openStart>=nowMs){
      rows.push({cycle:cycleNum, onAt:openStart, offAt:closeTime});
    }
    openStart += CYCLE_MS;
  }

  let html = '<table><thead><tr><th class="cycle-cell">Cycle</th><th class="status-cell">Status</th><th class="time-cell">Local Time</th></tr></thead><tbody>';
  for(const r of rows){
    html += `<tr>
      <td class="cycle-cell">${r.cycle}</td>
      <td class="status-cell"><span class="tag on">Online</span></td>
      <td class="time-cell">${pretty(r.onAt)}</td>
    </tr>
    <tr>
      <td class="cycle-cell"></td>
      <td class="status-cell"><span class="tag off">Offline</span></td>
      <td class="time-cell">${pretty(r.offAt)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  scheduleDiv.innerHTML = html;
}

/* ====== Admin dock (bottom) ====== */
function toggleDock(show){
  dockVisible = (show===undefined) ? !dockVisible : show;
  adminDock.style.display = dockVisible ? 'block' : 'none';
  if(dockVisible) adminDock.scrollIntoView({behavior:'smooth',block:'end'});
}
function unlockAdmin(){
  const ok = inputPwd.value === ADMIN_PWD;
  if(ok){
    isAdmin = true;
    adminLock.style.display='none';
    adminControls.style.display='block';
    inputTime.focus();
  }else{
    isAdmin = false;
    alert('Wrong password.');
  }
}
function applyRebase(){
  if(!isAdmin) return alert('Admin locked.');
  const v = (inputTime.value||'').trim();
  if(!v) return alert('Enter HH:MM');
  const [hh,mm]=v.split(':').map(Number);
  const d=new Date(); d.setHours(hh,mm,6,0);   // force :xx:06
  if(d.getTime()>Date.now()) d.setDate(d.getDate()-1); // if future, previous day
  anchor_ms = d.getTime();
  render(true);
}
function togglePause(){
  if(!isAdmin) return alert('Admin locked.');
  paused = !paused;
  alert(paused ? 'Hangar paused.' : 'Hangar resumed.');
}

/* ====== Header/admin interactions ====== */
secretLogo.addEventListener('click',()=>toggleDock(true));
document.addEventListener('keydown',e=>{ if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='a') toggleDock(true); });
btnUnlock.addEventListener('click', unlockAdmin);
btnApply.addEventListener('click', applyRebase);
btnPause.addEventListener('click', togglePause);
btnCloseDock.addEventListener('click', ()=>toggleDock(false));

/* ====== Patch date in local tz ====== */
patchDate.textContent = 'Site updated: ' + new Date().toLocaleString();

/* ====== Start ====== */
render(true);
setInterval(()=>render(),1000);
</script>
</body>
</html>
