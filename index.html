<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CZ Timers — Mammon</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0a0d14; --panel:#0b0f1aee; --panel-border:rgba(255,255,255,.08);
    --text:#ffffff; --muted:#cbd5e1; --ok:#22c55e; --danger:#ef4444;
    --accent:#fbbf24; --accent-2:#fde047; --shadow:rgba(0,0,0,.45)
  }
  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text); background:var(--bg); min-height:100vh;}

  /* Gros watermark Mammon */
  .wm{position:fixed; inset:0; pointer-events:none; z-index:0;
      background:url('/assets/mammon.png') center 40%/min(90vmin,1200px) no-repeat;
      opacity:.26; filter: drop-shadow(0 0 22px rgba(0,0,0,.65))}
  .overlay{position:relative; z-index:1;
      background:
        radial-gradient(90vw 60vh at 70% -20%, rgba(253,224,71,.10), transparent 60%),
        radial-gradient(70vw 50vh at -10% 0%, rgba(251,191,36,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.34), rgba(0,0,0,.22));
      min-height:100vh;}
  .wrap{max-width:980px; margin:0 auto; padding:18px 18px 60px;}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand-logo{width:28px; height:28px; background:url('/assets/mammon.png') center/contain no-repeat; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5)); cursor:pointer}
  .brand-title{font-weight:900; letter-spacing:.3px}
  .badge{font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111;}
  .header-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .mini-badge{font-size:12px; line-height:1; color:var(--ok); background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.45); padding:6px 10px; border-radius:999px}

  .panel{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:18px; box-shadow:0 12px 30px var(--shadow); backdrop-filter: blur(6px)}
  h1{margin:6px 0 6px; font-size:30px; font-weight:900}
  .bigStatus{font-size:40px; font-weight:900; margin:0 0 8px}
  .bigStatus.open{color:var(--ok)} .bigStatus.closed{color:var(--danger)}
  .until{font:14px/1.2 ui-monospace,monospace; margin:2px 0 8px; opacity:.95}
  .row{display:flex; gap:10px; justify-content:center; margin:6px 0 10px}
  .led{width:22px; height:22px; border-radius:7px; border:1px solid rgba(0,0,0,.6); background:#0b1323; box-shadow: inset 0 0 12px rgba(0,0,0,.6), 0 0 12px rgba(0,0,0,.25)}
  .led.g{ background:var(--ok); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 16px rgba(34,197,94,.45) }
  .led.r{ background:var(--danger); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 14px rgba(239,68,68,.35) }
  .clock{font:42px/1.1 ui-monospace,Menlo,Consolas,monospace; margin:6px 0 10px}
  .status{margin:8px 0 2px; font-weight:900; letter-spacing:.3px}
  .status.open{color:var(--ok)} .status.closed{color:var(--danger)}
  .sub{opacity:.95}
  .meta{margin-top:10px; font-size:12px; opacity:.9}
  .next{margin-top:8px; font-size:13px; opacity:.96}

  /* Planning 24 h */
  .sched{margin-top:12px}
  .sched table{width:100%; border-collapse:collapse; font-size:14px}
  .sched th,.sched td{padding:8px 10px; border-top:1px solid rgba(255,255,255,.08)}
  .sched th{text-align:left; opacity:.9}
  .tag{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15)}
  .tag.on{color:var(--ok); border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12)}
  .tag.off{color:var(--danger); border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12)}

  /* Privacy */
  .pp-cta-wrap{margin:22px 0 8px; display:flex; justify-content:center}
  .pp-cta{padding:9px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f172a; color:#fff; text-decoration:none}
  .pp-cta:hover{border-color:#334155}
  .privacy{display:none; margin-top:16px}
  .privacy .box{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:16px; box-shadow:0 12px 30px var(--shadow)}
  .privacy h2{margin:0 0 10px; font-size:20px; font-weight:900}
  .privacy h3{margin:16px 0 6px; font-size:16px; font-weight:800}
  .privacy p, .privacy li{color:#dbeafe}

  /* Admin minimal */
  .btn{padding:9px 12px; border-radius:12px; border:1px solid var(--panel-border); background:#0f172a; color:#fff; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111; border-color:transparent; font-weight:900}
  .admin .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px}
  .admin input[type="time"]{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b0e1a; color:#fff}

  /* Widget Nain */
  .t-head{position:fixed; right:14px; bottom:14px; z-index:5; display:flex; align-items:center; gap:10px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:8px 10px; border-radius:14px; backdrop-filter: blur(6px)}
  .t-head img{width:64px; height:64px; border-radius:12px; object-fit:cover; border:1px solid rgba(255,255,255,.2); cursor:pointer}
  .t-head .note{font-size:12px; opacity:.9}
  .t-killed{position:fixed; right:14px; bottom:14px; z-index:4; background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.45); padding:8px 12px; border-radius:14px; display:none}
</style>
</head>
<body>
<div class="wm" aria-hidden="true"></div>
<div class="overlay">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="brand">
        <div class="brand-logo" id="secretLogo" aria-hidden="true"></div>
        <div class="brand-title">CZ Timers</div>
        <span class="badge">LIVE</span>
      </div>
      <div class="header-right">
        <span class="mini-badge" id="patchBadge">Updated for Star Citizen Patch 4.3.0-LIVE (Hotfix 10188864)</span>
      </div>
    </header>

    <!-- Timer -->
    <section class="panel">
      <h1>Executive Hangar Status</h1>
      <div id="statusBig" class="bigStatus closed">OFFLINE</div>

      <div class="until">Time until next change: <span id="until">--:--</span></div>
      <div class="row" id="leds">
        <div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div>
      </div>

      <div class="clock" id="clock">--:--:--</div>
      <div class="status closed" id="status">Hangar Closed</div>
      <div class="sub" id="subtitle">Prochaine transition dans --:--:--</div>
      <div class="next" id="nextTimes">Prochaine fermeture : — • Prochaine ouverture : —</div>
      <div class="meta" id="modeMeta">Chargement…</div>

      <!-- Planning 24 h -->
      <div class="sched">
        <div class="next" style="margin-top:10px">Prochaines fenêtres (24 h)</div>
        <div id="schedule"></div>
      </div>

      <!-- Admin caché -->
      <div class="admin" id="adminPanel" style="display:none">
        <div class="row">
          <label for="openTime"><strong>Dernière ouverture (HH:MM)</strong> :</label>
          <input type="time" id="openTime" step="60" />
          <button class="btn primary" id="publish">Appliquer</button>
          <button class="btn" id="togglePause">Pause/Reprendre</button>
          <button class="btn" id="logout">Se déconnecter</button>
        </div>
      </div>
    </section>

    <!-- Privacy -->
    <div class="pp-cta-wrap">
      <a href="#privacy" id="ppBtn" class="pp-cta" aria-expanded="false" aria-controls="privacy">Privacy Policy</a>
    </div>
    <section class="privacy" id="privacy" aria-hidden="true">
      <div class="box">
        <h2>Privacy Policy</h2>
        <p><em>Effective Date: September 8, 2025</em></p>
        <h3>Information We Collect</h3>
        <p>We do <strong>not</strong> collect, sell, or share personal data. Preferences are saved locally in your browser.</p>
        <h3>Cookies &amp; Tracking</h3>
        <p>No cookies for now. If ads are enabled later, you’ll be able to control them in your browser.</p>
        <h3>Your Rights</h3>
        <p>Depending on where you live, GDPR/CCPA/CPRA may apply. Since no personal data is collected, this mainly concerns cookie choices.</p>
        <h3>Data Retention</h3>
        <p>Nothing on our servers. Local data remains until you clear it.</p>
        <h3>Children’s Privacy</h3>
        <p>No data knowingly collected from children under 13.</p>
        <h3>Changes</h3>
        <p>We may update this Policy from time to time.</p>
      </div>
    </section>

  </div>
</div>

<!-- Widget Nain -->
<div class="t-head" id="tHead">
  <img id="tHeadImg" src="/assets/nain.png" alt="nain" title="résous le problème capillaire" />
  <div class="note">résous le problème capillaire</div>
  <audio id="tSong" src="/assets/confused-song.mp3" preload="auto"></audio>
</div>
<div class="t-killed" id="tKilledMsg">— échec —</div>

<!-- Modal Admin -->
<div class="modal" id="modal" style="display:none">
  <div class="box" style="background:#0f1220; border:1px solid var(--panel-border); border-radius:12px; padding:16px; width:100%; max-width:360px">
    <h3 style="margin:0 0 10px; font-size:18px">Connexion admin</h3>
    <div class="field" style="display:flex; gap:8px">
      <input type="password" id="pwd" placeholder="Mot de passe" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b0e1a;color:#fff" />
      <button class="btn" id="doLogin">OK</button>
    </div>
    <div class="actions" style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end">
      <button class="btn" id="closeModal">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ======= Paramètres cycle ======= */
const OPEN_SEC   = 65*60;          // 65:00
const CLOSED_SEC = 2*3600 + 1;     // 2:00:01
const CYCLE_SEC  = OPEN_SEC + CLOSED_SEC; // 03:05:01
const DOTS = 5;
const ANCHOR_CYCLE = 49;           // #49 = aujourd’hui 20:14:06

/* ======= Références DOM ======= */
const elClock = document.getElementById('clock');
const elUntil = document.getElementById('until');
const elStatus = document.getElementById('status');
const elStatusBig = document.getElementById('statusBig');
const elSub = document.getElementById('subtitle');
const elNext = document.getElementById('nextTimes');
const elMode = document.getElementById('modeMeta');
const leds = document.getElementById('leds').children;
const scheduleDiv = document.getElementById('schedule');

const adminPanel = document.getElementById('adminPanel');
const secretLogo = document.getElementById('secretLogo');
const modal = document.getElementById('modal');
const pwdInput = document.getElementById('pwd');
const doLoginBtn = document.getElementById('doLogin');
const closeModal = document.getElementById('closeModal');
const inputTime = document.getElementById('openTime');
const btnPublish = document.getElementById('publish');
const btnPause = document.getElementById('togglePause');
const btnLogout = document.getElementById('logout');

const ppBtn = document.getElementById('ppBtn');
const ppSection = document.getElementById('privacy');

const tHead = document.getElementById('tHead');
const tHeadImg = document.getElementById('tHeadImg');
const tKilledMsg = document.getElementById('tKilledMsg');
const tSong = document.getElementById('tSong');

/* ======= État local ======= */
let cfg = { anchor_iso:null, paused:false };

/* ======= Utils ======= */
const pad=n=>String(n).padStart(2,'0');
const fmtHMS=s=>{s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`;};
const fmtMMSS=s=>{s=Math.max(0,Math.floor(s)); return `${Math.floor(s/60)}:${pad(s%60)}`;};
const pretty=ms=>new Date(ms).toLocaleString('fr-FR',{dateStyle:'short', timeStyle:'medium'});
const toISO=ms=>new Date(ms - new Date().getTimezoneOffset()*60000).toISOString().replace('.000Z','Z');
const anchorMs=()=>Date.parse(cfg.anchor_iso);

/* ======= Ancre = AUJOURD’HUI 20:14:06 ======= */
function setAnchorToday201406(){
  const now = new Date();
  const a = new Date(now);
  a.setHours(20,14,6,0);  // 20:14:06 local
  cfg.anchor_iso = toISO(a.getTime());
  inputTime.value = '20:14';
  elMode.textContent = 'Ancre = aujourd’hui 20:14:06 (cycle 49).';
}

/* ======= LEDs ======= */
function greensClosed(remainSec){
  const seg = CLOSED_SEC / DOTS;                 // ≈24 min/LED
  let g = DOTS - Math.ceil(remainSec / seg);     // 0..5 verts quand on approche
  return Math.max(0, Math.min(DOTS, g));
}
function greensOpen(remainSec){
  if (remainSec <= 5*60) return 0;               // 5 dernières minutes no LEDs
  const eff = Math.min(60*60, remainSec - 5*60); // 60 min “progress bar”
  return Math.max(0, Math.min(DOTS, Math.ceil(eff / (12*60))));
}

/* ======= Rendu ======= */
let lastMinute = -1;
function render(force=false){
  if(!cfg.anchor_iso){
    elClock.textContent='--:--:--'; elUntil.textContent='--:--';
    elStatusBig.textContent='OFFLINE'; elStatusBig.className='bigStatus closed';
    elStatus.textContent='Initialisation…'; scheduleDiv.innerHTML=''; return;
  }
  const now = Date.now();
  const aMs = anchorMs();
  const elapsed = (((now - aMs)/1000)%CYCLE_SEC + CYCLE_SEC)%CYCLE_SEC;
  const isOpen = elapsed < OPEN_SEC;
  const phaseSec = isOpen ? OPEN_SEC : CLOSED_SEC;
  const phaseElapsed = isOpen ? elapsed : (elapsed - OPEN_SEC);
  const remain = phaseSec - phaseElapsed;

  elUntil.textContent = fmtMMSS(remain);
  elClock.textContent = fmtHMS(remain);
  elStatus.className = 'status ' + (isOpen?'open':'closed');
  elStatus.textContent = 'Hangar ' + (isOpen?'Open':'Closed') + (cfg.paused?' (Paused)':'');
  elStatusBig.textContent = isOpen ? 'ONLINE' : 'OFFLINE';
  elStatusBig.className = 'bigStatus ' + (isOpen?'open':'closed');
  elSub.textContent = 'Prochaine transition ('+(isOpen?'fermeture':'ouverture')+') dans ' + fmtHMS(remain);

  const g = isOpen ? greensOpen(remain) : greensClosed(remain);
  for(let i=0;i<DOTS;i++) leds[i].className = 'led ' + (i<g?'g':'r');

  // Prochaine ouverture/fermeture
  const CYCLE_MS = CYCLE_SEC*1000;
  const nextOpen = aMs + (Math.floor((now - aMs)/CYCLE_MS)+1)*CYCLE_MS;
  const nextClose = aMs + OPEN_SEC*1000 + (Math.floor((now - aMs)/CYCLE_MS)+1)*CYCLE_MS;
  elNext.textContent = `Prochaine fermeture : ${pretty(nextClose)} • Prochaine ouverture : ${pretty(nextOpen)}`;

  const m = new Date(now).getMinutes();
  if (force || m!==lastMinute){ lastMinute=m; updateSchedule(now); }
}

/* ======= Planning 24 h ======= */
function updateSchedule(nowMs){
  const a = anchorMs();
  const cycleMs = CYCLE_SEC*1000;
  const rows=[];
  // dernière ouverture <= now
  let n = Math.floor((nowMs - a)/cycleMs);
  let openStart = a + n*cycleMs;
  if (openStart > nowMs){ n--; openStart -= cycleMs; }
  const horizon = nowMs + 24*3600*1000;

  while (openStart < horizon){
    const step = Math.round((openStart - a)/cycleMs);
    const cycleNum = ANCHOR_CYCLE + step;
    const closeTime = openStart + OPEN_SEC*1000;
    if (openStart >= nowMs) rows.push({cycle:cycleNum, type:'on',  at:openStart});
    if (closeTime>= nowMs) rows.push({cycle:cycleNum, type:'off', at:closeTime});
    openStart += cycleMs;
  }
  rows.sort((x,y)=>x.at-y.at);

  let html = '<table><thead><tr><th>Cycle</th><th>Status</th><th>Local Time</th></tr></thead><tbody>';
  for(const r of rows){
    html += `<tr>
      <td>${r.cycle}</td>
      <td><span class="tag ${r.type==='on'?'on':'off'}">${r.type==='on'?'Online':'Offline'}</span></td>
      <td>${pretty(r.at)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  scheduleDiv.innerHTML = html;
}

/* ======= Privacy toggle ======= */
function setPrivacyVisibility(show){
  ppSection.style.display = show ? 'block' : 'none';
  ppSection.setAttribute('aria-hidden', String(!show));
  ppBtn.setAttribute('aria-expanded', String(show));
  if (show) ppSection.scrollIntoView({behavior:'smooth'});
}
ppBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const showing = ppSection.style.display==='block';
  setPrivacyVisibility(!showing);
  if(!showing) history.replaceState(null,'','#privacy'); else history.replaceState(null,'',' ');
});
if (location.hash === '#privacy') setPrivacyVisibility(true);

/* ======= Admin caché minimal ======= */
let isAdmin=false;
function setAdminUI(v){ isAdmin=v; adminPanel.style.display=v?'flex':'none'; }
secretLogo.addEventListener('dblclick', ()=>{ modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); });
document.addEventListener('keydown', (e)=>{ if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='a'){ modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); }});
if (location.hash==='#admin'){ setTimeout(()=>{ modal.style.display='flex'; }, 50); }
document.getElementById('doLogin').onclick=()=>{ if(!pwdInput.value.trim()) return alert('Mot de passe ?'); setAdminUI(true); modal.style.display='none'; };
document.getElementById('closeModal').onclick=()=>{ modal.style.display='none'; };
btnLogout.onclick=()=> setAdminUI(false);

btnPublish.onclick=()=>{
  const v=inputTime.value.trim(); if(!v) return alert('Indique HH:MM');
  const [hh,mm]=v.split(':').map(Number);
  const d=new Date(); d.setHours(hh,mm,0,0);
  // si l'heure saisie est dans le futur on prend la veille
  if(d.getTime()>Date.now()) d.setDate(d.getDate()-1);
  cfg.anchor_iso = toISO(d.getTime());
  render(true);
};
btnPause.onclick=()=>{ cfg.paused=!cfg.paused; render(true); };

/* ======= Widget Nain ======= */
function setNainKilled(k){ if(k){ tHead.style.display='none'; tKilledMsg.style.display='block'; } else { tHead.style.display='flex'; tKilledMsg.style.display='none'; } }
tHeadImg.addEventListener('click', async ()=>{
  try{ await tSong.play(); }catch{}
  setNainKilled(true);   // pas de persistance → re-cliquable à chaque refresh
});
setNainKilled(false);

/* ======= Go ======= */
function boot(){ setAnchorToday201406(); render(true); setInterval(()=>{ if(!cfg.paused) render(); }, 1000); }
boot();
</script>
</body>
</html>
