<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CZ Timers — Mammon</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0a0d14; --panel:#0b0f1aee; --panel-border:rgba(255,255,255,.08);
    --text:#ffffff; --muted:#cbd5e1; --ok:#22c55e; --danger:#ef4444;
    --accent:#fbbf24; --accent-2:#fde047; --shadow:rgba(0,0,0,.45)
  }
  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{
    font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(80vw 60vh at 70% -20%, rgba(253,224,71,.06), transparent 60%),
      radial-gradient(70vw 50vh at -10% 0%, rgba(251,191,36,.06), transparent 60%),
      var(--bg) url('https://images.unsplash.com/photo-1517817748496-62bc3047b9ff?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat fixed;
    min-height:100vh;
  }
  .overlay{position:relative; z-index:1; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35)); min-height:100vh;}
  .wrap{max-width:980px; margin:0 auto; padding:18px 18px 60px;}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand-logo{width:28px; height:28px; background:url('/assets/mammon.png') center/contain no-repeat; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5)); cursor:pointer}
  .brand-title{font-weight:900; letter-spacing:.3px}
  .badge{font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111;}
  .header-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .mini-badge{font-size:12px; line-height:1; color:var(--ok); background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.45); padding:6px 10px; border-radius:999px}

  .panel{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:18px; box-shadow:0 12px 30px var(--shadow); backdrop-filter: blur(6px)}
  h1{margin:6px 0 10px; font-size:30px; font-weight:900}
  .clock{font:42px/1.1 ui-monospace,Menlo,Consolas,monospace; margin:6px 0 10px}
  .status{margin:8px 0 2px; font-weight:900; letter-spacing:.3px}
  .status.open{color:var(--ok)} .status.closed{color:var(--danger)}
  .sub{opacity:.95}
  .row{display:flex; gap:10px; justify-content:center; margin:12px 0 8px}
  .led{width:22px; height:22px; border-radius:7px; border:1px solid rgba(0,0,0,.6); background:#0b1323; box-shadow: inset 0 0 12px rgba(0,0,0,.6), 0 0 12px rgba(0,0,0,.25)}
  .led.g{ background:var(--ok); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 16px rgba(34,197,94,.45) }
  .led.r{ background:var(--danger); box-shadow: inset 0 0 10px rgba(0,0,0,.45), 0 0 14px rgba(239,68,68,.35) }
  .meta{margin-top:10px; font-size:12px; opacity:.9}
  .next{margin-top:12px; font-size:13px; opacity:.96}

  /* Planning 24h */
  .sched{margin-top:12px}
  .sched table{width:100%; border-collapse:collapse; font-size:14px}
  .sched th,.sched td{padding:8px 10px; border-top:1px solid rgba(255,255,255,.08)}
  .sched th{text-align:left; opacity:.9}
  .tag{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15)}
  .tag.on{color:var(--ok); border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12)}
  .tag.off{color:var(--danger); border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12)}

  /* Privacy */
  .pp-cta-wrap{margin:22px 0 8px; display:flex; justify-content:center}
  .pp-cta{padding:9px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f172a; color:#fff; text-decoration:none}
  .pp-cta:hover{border-color:#334155}
  .privacy{display:none; margin-top:16px}
  .privacy .box{background:var(--panel); border:1px solid var(--panel-border); border-radius:16px; padding:16px; box-shadow:0 12px 30px var(--shadow)}
  .privacy h2{margin:0 0 10px; font-size:20px; font-weight:900}

  /* Admin */
  .btn{padding:9px 12px; border-radius:12px; border:1px solid var(--panel-border); background:#0f172a; color:#fff; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#111; border-color:transparent; font-weight:900}
  .admin .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px}
  .num{width:84px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b0e1a;color:#fff}
  .admin input[type="time"]{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b0e1a; color:#fff}

  /* Tête cliquable */
  .t-head{position:fixed; right:14px; bottom:14px; z-index:5; display:flex; align-items:center; gap:10px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:8px 10px; border-radius:14px; backdrop-filter: blur(6px)}
  .t-head img{width:56px; height:56px; border-radius:999px; object-fit:cover; border:1px solid rgba(255,255,255,.2); cursor:pointer}
  .t-head .note{font-size:12px; opacity:.9}
  .t-killed{position:fixed; right:14px; bottom:14px; z-index:4; background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.45); padding:8px 12px; border-radius:14px; display:none}
</style>
</head>
<body>
<div class="overlay">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="brand">
        <div class="brand-logo" id="secretLogo" aria-hidden="true" title=" "></div>
        <div class="brand-title">CZ Timers</div>
        <span class="badge">LIVE</span>
      </div>
      <div class="header-right">
        <span class="mini-badge" id="patchBadge" title="Star Citizen patch">
          Updated for Star Citizen Patch 4.3.0-LIVE (Hotfix 10188864)
        </span>
      </div>
    </header>

    <!-- Panel Timer -->
    <section class="panel">
      <h1>Executive Hangar Timer</h1>
      <div class="clock" id="clock">--:--:--</div>

      <div class="row" id="leds">
        <div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div><div class="led r"></div>
      </div>

      <div class="status closed" id="status">Hangar Closed</div>
      <div class="sub" id="subtitle">Prochaine transition dans --:--:--</div>

      <div class="next" id="nextTimes">Prochaine fermeture : — • Prochaine ouverture : —</div>
      <div class="meta" id="modeMeta">Chargement…</div>

      <!-- Planning 24h -->
      <div class="sched" id="scheduleWrap">
        <div class="next" style="margin-top:10px">Prochaines fenêtres (24 h)</div>
        <div id="schedule"></div>
      </div>

      <!-- Admin (caché par défaut) -->
      <div class="admin" id="adminPanel" style="display:none">
        <div class="row">
          <label for="openTime"><strong>Dernière ouverture (HH:MM)</strong> :</label>
          <input type="time" id="openTime" step="60" />
        </div>
        <div class="row">
          <button class="btn primary" id="publishGlobal">Mettre à jour GLOBAL</button>
          <button class="btn" id="togglePauseGlobal">Pause/Reprendre</button>
          <button class="btn" id="forceOpenNow">Forcer : Hangar ouvert maintenant</button>
          <button class="btn" id="forceClosedNow">Forcer : Hangar fermé maintenant</button>
          <button class="btn" id="reload">Recharger</button>
          <button class="btn" id="logout">Se déconnecter</button>
        </div>
        <div class="row">
          <span style="font-size:12px;opacity:.85">Calage express :</span>
          <input class="num" type="number" id="minsToClose" min="0" max="65" placeholder="mins" />
          <button class="btn" id="syncCloseIn">Fermeture dans X min</button>
          <input class="num" type="number" id="minsToOpen" min="0" max="120" placeholder="mins" />
          <button class="btn" id="syncOpenIn">Ouverture dans X min</button>
        </div>
      </div>
    </section>

    <!-- Privacy -->
    <div class="pp-cta-wrap">
      <a href="#privacy" id="ppBtn" class="pp-cta" aria-expanded="false" aria-controls="privacy">Privacy Policy</a>
    </div>
    <section class="privacy" id="privacy" aria-hidden="true">
      <div class="box">
        <h2>Privacy Policy</h2>
        <p>We do not collect personal data. Preferences peuvent être stockées en Local Storage. Si un backend est présent, seules les infos de timer global sont échangées.</p>
      </div>
    </section>

  </div>
</div>

<!-- Tête cliquable -->
<div class="t-head" id="tHead">
  <img id="tHeadImg" src="/assets/t-head.png" alt="T" title="(touche le T pour des auec)" />
  <div class="note">(touche le T pour des auec)</div>
  <audio id="tSong" src="/assets/confused-song.mp3" preload="auto"></audio>
</div>
<div class="t-killed" id="tKilledMsg">— tu a tuer le T bravo ! —</div>

<!-- Modal Admin (login) -->
<div class="modal" id="modal" style="display:none">
  <div class="box" style="background:#0f1220; border:1px solid var(--panel-border); border-radius:12px; padding:16px; width:100%; max-width:360px">
    <h3 style="margin:0 0 10px; font-size:18px">Connexion admin</h3>
    <div class="field" style="display:flex; gap:8px">
      <input type="password" id="pwd" placeholder="Mot de passe admin (Vercel → ADMIN_PASSWORD)" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b0e1a;color:#fff" />
      <button class="btn" id="doLogin">OK</button>
    </div>
    <div class="actions" style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end">
      <button class="btn" id="closeModal">Fermer</button>
    </div>
  </div>
</div>

<script>
  /* ===== Cycle + LEDs ===== */
  const OPEN_SEC   = 65*60;   // 65:00
  const CLOSED_SEC = 7201;    // 2:00:01
  const CYCLE_SEC  = OPEN_SEC + CLOSED_SEC;
  const DOTS=5;

  /* ===== Elements ===== */
  const elClock=document.getElementById('clock');
  const elStatus=document.getElementById('status');
  const elSub=document.getElementById('subtitle');
  const leds=document.getElementById('leds').children;
  const elNext=document.getElementById('nextTimes');
  const elMode=document.getElementById('modeMeta');
  const scheduleDiv=document.getElementById('schedule');

  const adminPanel=document.getElementById('adminPanel');
  const inputTime=document.getElementById('openTime');
  const btnPublish=document.getElementById('publishGlobal');
  const btnPause=document.getElementById('togglePauseGlobal');
  const btnForceOpen=document.getElementById('forceOpenNow');
  const btnForceClosed=document.getElementById('forceClosedNow');
  const btnReload=document.getElementById('reload');
  const btnLogout=document.getElementById('logout');

  const inputMinsToClose=document.getElementById('minsToClose');
  const inputMinsToOpen=document.getElementById('minsToOpen');
  const btnSyncCloseIn=document.getElementById('syncCloseIn');
  const btnSyncOpenIn=document.getElementById('syncOpenIn');

  const ppBtn=document.getElementById('ppBtn');
  const ppSection=document.getElementById('privacy');

  const modal=document.getElementById('modal');
  const pwdInput=document.getElementById('pwd');
  const doLoginBtn=document.getElementById('doLogin');
  const closeModal=document.getElementById('closeModal');
  const secretLogo=document.getElementById('secretLogo');

  const tHead=document.getElementById('tHead');
  const tHeadImg=document.getElementById('tHeadImg');
  const tKilledMsg=document.getElementById('tKilledMsg');
  const tSong=document.getElementById('tSong');

  /* ===== State (local fallback) ===== */
  let cfg={anchor_iso:null, manual_offset_seconds:0, paused:false};
  let isAdmin=false, adminPwd=null;

  /* ===== Utils ===== */
  const pad=n=>String(n).padStart(2,'0');
  const fmt=s=>{s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`;};
  const pretty=ms=>new Date(ms).toLocaleString('fr-FR',{dateStyle:'short', timeStyle:'short'});
  const toISO=ms=>new Date(ms - new Date().getTimezoneOffset()*60000).toISOString().replace('.000Z','Z');
  const anchorMs=()=>Date.parse(cfg.anchor_iso)+(cfg.manual_offset_seconds||0)*1000;
  const nextAfter=(startMs,stepMs,nowMs)=>(nowMs<startMs)?startMs:startMs+(Math.floor((nowMs-startMs)/stepMs)+1)*stepMs;

  /* ===== Fallback ancre (d’après ton tableau) =====
     Online 09/09/2025 20:14:06 local  -> ancre d'ouverture */
  function setFallbackFromDataset(){
    const d=new Date();
    d.setFullYear(2025, 8, 9); // septembre (0-index)
    d.setHours(20,14,6,0);
    cfg.anchor_iso = toISO(d.getTime());
    cfg.manual_offset_seconds = 0;
    elMode.textContent='Ancre locale : 09/09/2025 20:14:06 — cycle 65:00 / 2:00:01';
  }

  /* ===== LEDs ===== */
  function greenCountClosed(remainSec){
    const seg = CLOSED_SEC / DOTS;                 // ~24 min/LED
    let cnt = DOTS - Math.ceil(remainSec / seg);   // 0..5 (5 avant ouverture)
    return Math.max(0, Math.min(DOTS, cnt));
  }
  function greenCountOpen(remainSec){
    if (remainSec <= 5*60) return 0;               // “black” 5 dernières min
    const eff = Math.min(60*60, remainSec - 5*60); // 60 min de LEDs actives
    return Math.max(0, Math.min(DOTS, Math.ceil(eff / (12*60))));
  }

  /* ===== Rendu + Planning ===== */
  let lastMinute=-1;
  function render(force=false){
    if(!cfg.anchor_iso){
      elClock.textContent='--:--:--';
      elStatus.className='status closed';
      elStatus.textContent='Initialisation…';
      elSub.textContent='Aucune ancre définie';
      elNext.textContent='—';
      scheduleDiv.innerHTML='';
      return;
    }
    const now=Date.now();
    const elapsed=(((now-anchorMs())/1000)%CYCLE_SEC+CYCLE_SEC)%CYCLE_SEC;
    const isOpen = elapsed < OPEN_SEC;
    const phaseSec = isOpen ? OPEN_SEC : CLOSED_SEC;
    const phaseElapsed = isOpen ? elapsed : (elapsed-OPEN_SEC);
    const remain = phaseSec - phaseElapsed;

    elClock.textContent = fmt(remain);
    elStatus.className='status '+(isOpen?'open':'closed');
    elStatus.textContent = 'Hangar '+(isOpen?'Open':'Closed') + (cfg.paused?' (Paused)':'');
    elSub.textContent = 'Prochaine transition ('+(isOpen?'fermeture':'ouverture')+') dans '+fmt(remain);

    const green = isOpen ? greenCountOpen(remain) : greenCountClosed(remain);
    for(let i=0;i<DOTS;i++) leds[i].className='led '+(i<green?'g':'r');

    const nClose=nextAfter(anchorMs()+OPEN_SEC*1000, CYCLE_SEC*1000, now);
    const nOpen =nextAfter(anchorMs(),                CYCLE_SEC*1000, now);
    elNext.textContent = `Prochaine fermeture : ${pretty(nClose)} • Prochaine ouverture : ${pretty(nOpen)}`;

    const m=new Date(now).getMinutes();
    if(force || m!==lastMinute){ lastMinute=m; updateSchedule(now); }
  }

  function updateSchedule(nowMs){
    const rows=[];
    const horizon = nowMs + 24*3600*1000; // +24h
    const a = anchorMs();

    // dernière ouverture passée
    const k = Math.floor((nowMs - a)/(CYCLE_SEC*1000));
    let openStart = a + k*CYCLE_SEC*1000;
    if (openStart > nowMs) openStart -= CYCLE_SEC*1000;

    while (openStart < horizon){
      const closeTime = openStart + OPEN_SEC*1000;
      if (openStart >= nowMs) rows.push({type:'on', at: openStart});
      if (closeTime >= nowMs) rows.push({type:'off', at: closeTime});
      openStart += CYCLE_SEC*1000;
    }

    rows.sort((a,b)=>a.at-b.at);

    let html = '<table><thead><tr><th>Évènement</th><th>Heure locale</th></tr></thead><tbody>';

    // ligne “en cours”
    const curOpenStart = a + Math.floor((nowMs - a)/(CYCLE_SEC*1000))*CYCLE_SEC*1000;
    const curClose = curOpenStart + OPEN_SEC*1000;
    if (curOpenStart <= nowMs && nowMs < curClose){
      html += `<tr><td><span class="tag on">Online (en cours)</span></td><td>Fermeture à ${pretty(curClose)}</td></tr>`;
    }

    for(const r of rows){
      if(r.at < nowMs) continue; // on masque les passés
      html += `<tr><td><span class="tag ${r.type==='on'?'on':'off'}">${r.type==='on'?'Online':'Offline'}</span></td><td>${pretty(r.at)}</td></tr>`;
    }
    html += '</tbody></table>';
    scheduleDiv.innerHTML = html;
  }

  /* ===== API (optionnel) ===== */
  async function loadCfg(){
    try{
      const r=await fetch('/api/anchor?ts='+Date.now(),{cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      const js=await r.json();
      cfg.anchor_iso=js.anchor_iso||null;
      cfg.manual_offset_seconds=js.manual_offset_seconds||0;
      cfg.paused=!!js.paused;
      if(!cfg.anchor_iso) setFallbackFromDataset();
      elMode.textContent='Config chargée. Dernière MAJ : '+pretty(Date.parse(cfg.anchor_iso));
      const d=new Date(); inputTime.value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      render(true);
    }catch{
      setFallbackFromDataset();
      const d=new Date(); inputTime.value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      render(true);
    }
  }

  /* ===== Admin ===== */
  function setAdminUI(v){ isAdmin=v; adminPanel.style.display=v?'flex':'none'; if(!v) adminPwd=null; }
  secretLogo.addEventListener('dblclick', ()=>{ modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); });
  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='a'){ modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); } });
  if (location.hash === '#admin'){ setTimeout(()=>{ modal.style.display='flex'; pwdInput.value=''; pwdInput.focus(); }, 50); }

  doLoginBtn.onclick= ()=>{ adminPwd=pwdInput.value.trim(); if(!adminPwd){ alert('Entre le mot de passe'); return; } setAdminUI(true); modal.style.display='none'; };
  closeModal.onclick=()=>{ modal.style.display='none'; };
  btnLogout.onclick=()=> setAdminUI(false);

  function isoFromHHMM(hhmm){
    const [hh,mm]=hhmm.split(':').map(Number);
    const now=new Date(); const d=new Date(now);
    d.setHours(hh,mm,0,0); if(d.getTime()>now.getTime()) d.setDate(d.getDate()-1);
    return toISO(d.getTime());
  }

  function postAnchorOrLocal(iso, pausedFlag){
    // Essaie le backend, sinon applique local
    fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:adminPwd||'',anchor_iso:iso,manual_offset_seconds:0,paused:typeof pausedFlag==='boolean'?pausedFlag:cfg.paused})})
    .then(async r=>{
      if(!r.ok) throw new Error('POST failed');
      cfg=await r.json(); render(true);
    })
    .catch(()=>{ cfg.anchor_iso=iso; if(typeof pausedFlag==='boolean') cfg.paused=pausedFlag; render(true); });
  }

  btnPublish.onclick= ()=>{ const v=inputTime.value.trim(); if(!v) return alert('Indique HH:MM'); postAnchorOrLocal(isoFromHHMM(v)); };
  btnPause.onclick   = ()=>{ postAnchorOrLocal(cfg.anchor_iso, !cfg.paused); };
  btnReload.onclick  = loadCfg;

  btnForceOpen.onclick  = ()=>{ postAnchorOrLocal(toISO(Date.now())); };
  btnForceClosed.onclick= ()=>{ postAnchorOrLocal(toISO(Date.now() - OPEN_SEC*1000 - 1000)); };

  btnSyncCloseIn.onclick= ()=>{ const x=parseInt(inputMinsToClose.value,10); if(Number.isNaN(x)||x<0||x>65) return alert('0–65');
    const iso=toISO(Date.now() - (OPEN_SEC*1000 - x*60*1000)); postAnchorOrLocal(iso); };
  btnSyncOpenIn.onclick = ()=>{ const x=parseInt(inputMinsToOpen.value,10); if(Number.isNaN(x)||x<0||x>120) return alert('0–120');
    const iso=toISO(Date.now() - (CYCLE_SEC*1000 - x*60*1000)); postAnchorOrLocal(iso); };

  /* ===== Privacy toggle ===== */
  function setPrivacyVisibility(show){
    ppSection.style.display = show ? 'block' : 'none';
    ppSection.setAttribute('aria-hidden', String(!show));
    ppBtn.setAttribute('aria-expanded', String(show));
    if (show) ppSection.scrollIntoView({behavior:'smooth'});
  }
  function togglePrivacy(e){
    e && e.preventDefault();
    const showing = ppSection.style.display === 'block';
    setPrivacyVisibility(!showing);
    if (!showing) history.replaceState(null,'','#privacy'); else history.replaceState(null,'',' ');
  }
  ppBtn.addEventListener('click', togglePrivacy);
  if (location.hash === '#privacy') setPrivacyVisibility(true);

  /* ===== Tête : son + message (local) ===== */
  const LS_T_KILLED='t_killed';
  function setTKilledUI(killed){
    if(killed){ tHead.style.display='none'; tKilledMsg.style.display='block'; }
    else      { tHead.style.display='flex'; tKilledMsg.style.display='none'; }
  }
  tHeadImg.addEventListener('click', async ()=>{
    try{ await tSong.play(); }catch{}
    setTKilledUI(true);
    try{ localStorage.setItem(LS_T_KILLED,'1'); }catch{}
  });
  (function(){ let k=false; try{ k=localStorage.getItem(LS_T_KILLED)==='1'; }catch{} setTKilledUI(k); })();

  /* ===== Tick & Go ===== */
  setInterval(()=>{ if(!cfg.paused) render(); },1000);
  loadCfg();
</script>
</body>
</html>
